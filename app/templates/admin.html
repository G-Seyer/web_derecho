<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Administración – Folios y pólizas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f7fb; }
    .card { border:0; border-radius:14px; box-shadow: 0 8px 26px rgba(16,24,40,.06); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .badge-dot { display:inline-flex; align-items:center; gap:.4rem; }
    .badge-dot::before { content:""; width:.6rem; height:.6rem; border-radius:50%; background:#adb5bd; }
    .ok .badge-dot::before { background:#28a745; }
    .pend .badge-dot::before { background:#ffc107; }
    .no .badge-dot::before { background:#dc3545; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="/">AEPRA – Admin</a>
  </div>
</nav>

<div class="container pb-5">
  <h1 class="h3 mb-4">Administración de procesos por folio</h1>

  <!-- Generador de folios -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">Generador de folios</h2>
      <div class="d-flex flex-wrap gap-2">
        <button id="btnGenerar" class="btn btn-primary">Generar folio</button>
        <input id="folioOut" class="form-control mono" style="max-width: 360px" placeholder="Aún sin folio" readonly>
        <button id="btnCopiar" class="btn btn-outline-secondary" disabled>Copiar</button>
      </div>
      <small class="text-muted d-block mt-2">El folio se usará en los formularios de arrendador/arrendatario.</small>
    </div>
  </div>

  <!-- Buscador por folio -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">Buscar por folio</h2>
      <form id="frmBuscar" class="row g-2 align-items-center">
        <div class="col-sm-6 col-md-5">
          <input id="folioBuscar" class="form-control mono" placeholder="Ej. AEPRA-202508-AB12" required pattern="^AEPRA-\\d{6}-[A-Z0-9]{4}$">
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" type="submit">Buscar</button>
        </div>
      </form>

      <div id="resumenWrap" class="mt-4 d-none">
        <h3 class="h6">Resumen</h3>
        <div class="row g-3">
          <div class="col-md-3">
            <div class="card"><div class="card-body">
              <div class="text-muted small">Folio</div>
              <div id="sumFolio" class="mono h6 mb-0">–</div>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card"><div class="card-body">
              <div class="text-muted small">Docs. Arrendador</div>
              <div id="sumArr" class="h6 mb-0">0</div>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card"><div class="card-body">
              <div class="text-muted small">Docs. Arrendatario</div>
              <div id="sumInq" class="h6 mb-0">0</div>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card"><div class="card-body">
              <div class="text-muted small">Total documentos</div>
              <div id="sumTot" class="h6 mb-0">0</div>
            </div></div>
          </div>
        </div>
      </div>

      <div id="polizaWrap" class="mt-4 d-none">
        <h3 class="h6">Póliza</h3>
        <form id="frmPoliza" class="row g-2 align-items-end">
          <div class="col-sm-4 col-md-3">
            <label class="form-label">Fecha de inicio</label>
            <input id="polInicio" type="date" class="form-control">
          </div>
          <div class="col-sm-4 col-md-3">
            <label class="form-label">Fecha de vencimiento</label>
            <input id="polFin" type="date" class="form-control" readonly>
          </div>
          <div class="col-sm-4 col-md-3">
            <button class="btn btn-success mt-3 mt-sm-0" type="submit">Guardar póliza</button>
          </div>
        </form>
      </div>

      <div id="docsWrap" class="mt-4 d-none">
        <h3 class="h6">Documentos</h3>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Usuario</th><th>Tipo</th><th>Nombre</th><th>MIME</th><th>Tamaño</th><th>Fecha</th><th>Ruta</th>
              </tr>
            </thead>
            <tbody id="tbodyDocs"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTRO DE PÓLIZAS POR MESES RESTANTES -->
  <div class="card mb-5">
    <div class="card-body">
      <h2 class="h5 mb-3">Filtrar pólizas por meses restantes</h2>
      <form id="frmFiltro" class="row g-2 align-items-center">
        <div class="col-auto">
          <label class="form-label">Hasta</label>
          <select id="maxMeses" class="form-select">
            <option value="1">1 mes</option>
            <option value="2">2 meses</option>
            <option value="3" selected>3 meses</option>
            <option value="6">6 meses</option>
            <option value="12">12 meses</option>
          </select>
        </div>
        <div class="col-auto form-check ms-2">
          <input id="inclVencidas" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="inclVencidas">Incluir vencidas</label>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary" type="submit">Filtrar</button>
        </div>
      </form>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Folio</th>
              <th>Inicio</th>
              <th>Vencimiento</th>
              <th>Meses restantes</th>
              <th>Días restantes</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tbodyPolizas"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
// -------- Generar folio --------
const out = document.getElementById('folioOut');
const btnGen = document.getElementById('btnGenerar');
const btnCopy = document.getElementById('btnCopiar');

function localFolio(){
  const d = new Date();
  const ym = d.getFullYear().toString()+String(d.getMonth()+1).padStart(2,'0');
  const abc = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let suf=''; for(let i=0;i<4;i++) suf += abc[Math.floor(Math.random()*abc.length)];
  return `AEPRA-${ym}-${suf}`;
}

btnGen.addEventListener('click', async ()=>{
  try {
    const r = await fetch('/api/admin/folio-nuevo');
    if (r.ok) {
      const j = await r.json();
      if (j && j.folio) { out.value = j.folio; btnCopy.disabled = false; return; }
    }
  } catch (e) { /* ignora */ }
  // Fallback local
  out.value = localFolio();
  btnCopy.disabled = false;
});

btnCopy.addEventListener('click', async ()=>{
  if(!out.value) return;
  await navigator.clipboard.writeText(out.value);
  btnCopy.textContent = 'Copiado ✓';
  setTimeout(()=>btnCopy.textContent='Copiar', 1200);
});

// -------- Buscar por folio --------
const frmBuscar = document.getElementById('frmBuscar');
const resumenWrap = document.getElementById('resumenWrap');
const polizaWrap = document.getElementById('polizaWrap');
const docsWrap = document.getElementById('docsWrap');
const tbodyDocs = document.getElementById('tbodyDocs');
let folioActual = '';

frmBuscar.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const input = document.getElementById('folioBuscar');
  const folio = input.value.trim().toUpperCase();
  if (!/^AEPRA-\\d{6}-[A-Z0-9]{4}$/.test(folio)) { input.reportValidity(); return; }

  const r = await fetch('/api/admin/folio/'+encodeURIComponent(folio));
  const j = await r.json();

  folioActual = folio;
  // Resumen
  const sum = j.resumen || {};
  document.getElementById('sumFolio').textContent = sum.folio || folio;
  document.getElementById('sumArr').textContent = sum.docs_arrendador ?? 0;
  document.getElementById('sumInq').textContent = sum.docs_arrendatario ?? 0;
  document.getElementById('sumTot').textContent = sum.total_docs ?? 0;
  resumenWrap.classList.remove('d-none');

  // Póliza
  const pol = j.poliza || {};
  document.getElementById('polInicio').value = pol.fecha_inicio || '';
  document.getElementById('polFin').value = pol.fecha_fin || '';
  polizaWrap.classList.remove('d-none');

  // Documentos
  tbodyDocs.innerHTML = '';
  (j.documentos || []).forEach(d => {
    const tr = document.createElement('tr');
    function td(txt){ const el = document.createElement('td'); el.textContent = txt ?? '–'; return el; }
    tr.append(td(d.tipo_usuario), td(d.tipo_documento), td(d.nombre_archivo),
              td(d.mime), td(d.tamano_bytes), td(d.fecha_subida), td(d.ruta));
    tbodyDocs.appendChild(tr);
  });
  docsWrap.classList.remove('d-none');
});

// -------- Guardar póliza --------
document.getElementById('frmPoliza').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fi = document.getElementById('polInicio').value;
  if(!folioActual || !fi){ alert('Ingresa un folio válido y una fecha de inicio'); return; }
  const res = await fetch('/api/admin/poliza', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ folio: folioActual, fecha_inicio: fi })
  });
  const out = await res.json();
  if (out.ok){
    document.getElementById('polInicio').value = out.fecha_inicio || fi;
    document.getElementById('polFin').value = out.fecha_fin || '';
    alert('Póliza guardada');
  } else {
    alert(out.error || 'Error guardando póliza');
  }
});

// -------- Filtro de pólizas por meses restantes --------
const frmFiltro = document.getElementById('frmFiltro');
const tbodyPolizas = document.getElementById('tbodyPolizas');

frmFiltro.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const maxMeses = document.getElementById('maxMeses').value;
  const incl = document.getElementById('inclVencidas').checked ? 1 : 0;
  const r = await fetch(`/api/admin/polizas?max_meses=${maxMeses}&incluir_vencidas=${incl}`);
  const j = await r.json();
  tbodyPolizas.innerHTML = '';
  (j.items || []).forEach(p => {
    const tr = document.createElement('tr');
    const estado = p.dias_restantes < 0 ? 'Vencida' : (p.meses_restantes <= 0 ? 'Este mes' : 'Vigente');
    tr.innerHTML = `
      <td class="mono">${p.folio}</td>
      <td>${p.fecha_inicio || ''}</td>
      <td>${p.fecha_fin || ''}</td>
      <td>${p.meses_restantes}</td>
      <td>${p.dias_restantes}</td>
      <td>${estado}</td>
    `;
    tbodyPolizas.appendChild(tr);
  });
});
</script>
</body>
</html>
