<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Administración – Folios y pólizas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f7fb; }
    .card { border:0; border-radius:14px; box-shadow: 0 8px 26px rgba(16,24,40,.06); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .badge-dot { display:inline-flex; align-items:center; gap:.4rem; }
    .badge-dot::before { content:""; width:.6rem; height:.6rem; border-radius:50%; background:#adb5bd; }
    .ok .badge-dot::before { background:#28a745; }
    .pend .badge-dot::before { background:#ffc107; }
    .no .badge-dot::before { background:#dc3545; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="/">AEPRA – Admin</a>
  </div>
</nav>

<div class="container pb-5">
  <h1 class="h3 mb-4">Administración de procesos por folio</h1>

  <!-- Generador de folios -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">Generador de folios</h2>
      <div class="d-flex flex-wrap gap-2">
        <button id="btnGenerar" class="btn btn-primary">Generar folio</button>
        <input id="folioOut" class="form-control mono" style="max-width: 360px" placeholder="Aún sin folio" readonly>
        <button id="btnCopiar" class="btn btn-outline-secondary" disabled>Copiar</button>
      </div>
      <small class="text-muted d-block mt-2">El folio se usará en los formularios de arrendador/arrendatario.</small>
    </div>
  </div>

  <!-- Buscador por folio -->
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">Buscar por folio</h2>
      <form id="frmBuscar" class="row g-2 align-items-center">
        <div class="col-sm-6 col-md-5">
          <input id="folioBuscar"
       class="form-control mono"
       placeholder="Ej. AEPRA-202508-AB12"
       required
       pattern="^AEPRA-\d{6}-[A-Z0-9]{4}$"
       oninput="this.value=this.value.toUpperCase().replace(/\s+/g,'');">
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" type="submit">Buscar</button>
        </div>
      </form>

      <div id="resumenWrap" class="mt-4 d-none">
        <h3 class="h6">Resumen</h3>
        <div class="row g-3">
          <div class="col-md-3">
            <div class="card"><div class="card-body">
              <div class="text-muted small">Folio</div>
              <div id="sumFolio" class="mono h6 mb-0">–</div>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card"><div class="card-body">
              <div class="text-muted small">Docs. Arrendador</div>
              <div id="sumArr" class="h6 mb-0">0</div>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card"><div class="card-body">
              <div class="text-muted small">Docs. Arrendatario</div>
              <div id="sumInq" class="h6 mb-0">0</div>
            </div></div>
          </div>
          <div class="col-md-3">
            <div class="card"><div class="card-body">
              <div class="text-muted small">Total documentos</div>
              <div id="sumTot" class="h6 mb-0">0</div>
            </div></div>
          </div>
        </div>
      </div>

      <div id="polizaWrap" class="mt-4 d-none">
        <h3 class="h6">Póliza</h3>
        <form id="frmPoliza" class="row g-2 align-items-end">
          <div class="col-sm-4 col-md-3">
            <label class="form-label">Fecha de inicio</label>
            <input id="polInicio" type="date" class="form-control">
          </div>
          <div class="col-sm-4 col-md-3">
            <label class="form-label">Fecha de vencimiento</label>
            <input id="polFin" type="date" class="form-control" readonly>
          </div>
          <div class="col-sm-4 col-md-3">
            <button class="btn btn-success mt-3 mt-sm-0" type="submit">Guardar póliza</button>
          </div>
        </form>
      </div>

      <div id="docsWrap" class="mt-4 d-none">
        <h3 class="h6">Documentos</h3>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Usuario</th><th>Tipo</th><th>Nombre</th><th>MIME</th><th>Tamaño</th><th>Fecha</th><th>Ruta</th>
              </tr>
            </thead>
            <tbody id="tbodyDocs"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTRO DE PÓLIZAS POR MESES RESTANTES -->
  <div class="card mb-5">
    <div class="card-body">
      <h2 class="h5 mb-3">Filtrar pólizas por meses restantes</h2>
      <form id="frmFiltro" class="row g-2 align-items-center">
        <div class="col-auto">
          <label class="form-label">Hasta</label>
          <select id="maxMeses" class="form-select">
            <option value="1">1 mes</option>
            <option value="2">2 meses</option>
            <option value="3" selected>3 meses</option>
            <option value="6">6 meses</option>
            <option value="12">12 meses</option>
          </select>
        </div>
        <div class="col-auto form-check ms-2">
          <input id="inclVencidas" class="form-check-input" type="checkbox">
          <label class="form-check-label" for="inclVencidas">Incluir vencidas</label>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary" type="submit">Filtrar</button>
        </div>
      </form>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Folio</th>
              <th>Inicio</th>
              <th>Vencimiento</th>
              <th>Meses restantes</th>
              <th>Días restantes</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tbodyPolizas"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
// -------- Generar folio --------
const out = document.getElementById('folioOut');
const btnGen = document.getElementById('btnGenerar');
const btnCopy = document.getElementById('btnCopiar');

function localFolio(){
  const d = new Date();
  const ym = d.getFullYear().toString()+String(d.getMonth()+1).padStart(2,'0');
  const abc = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let suf=''; for(let i=0;i<4;i++) suf += abc[Math.floor(Math.random()*abc.length)];
  return `AEPRA-${ym}-${suf}`;
}

btnGen.addEventListener('click', async ()=>{
  try {
    const r = await fetch('/api/admin/folio-nuevo');
    if (r.ok) {
      const j = await r.json();
      if (j && j.folio) { out.value = j.folio; btnCopy.disabled = false; return; }
    }
  } catch (e) { /* ignora */ }
  // Fallback local
  out.value = localFolio();
  btnCopy.disabled = false;
});

btnCopy.addEventListener('click', async ()=>{
  if(!out.value) return;
  await navigator.clipboard.writeText(out.value);
  btnCopy.textContent = 'Copiado ✓';
  setTimeout(()=>btnCopy.textContent='Copiar', 1200);
});

// -------- Buscar por folio --------
const frmBuscar = document.getElementById('frmBuscar');
const resumenWrap = document.getElementById('resumenWrap');
const polizaWrap = document.getElementById('polizaWrap');
const docsWrap = document.getElementById('docsWrap');
const tbodyDocs = document.getElementById('tbodyDocs');
let folioActual = '';

frmBuscar.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const input = document.getElementById('folioBuscar');
  const folio = input.value.trim().toUpperCase().replace(/\s+/g,'');  // limpia espacios

  if (!/^AEPRA-\d{6}-[A-Z0-9]{4}$/.test(folio)) {
    input.reportValidity();
    return;
  }

  const r = await fetch('/api/admin/folio/'+encodeURIComponent(folio));
  const j = await r.json();

  folioActual = folio;
  // Resumen
  const sum = j.resumen || {};
  document.getElementById('sumFolio').textContent = sum.folio || folio;
  document.getElementById('sumArr').textContent = sum.docs_arrendador ?? 0;
  document.getElementById('sumInq').textContent = sum.docs_arrendatario ?? 0;
  document.getElementById('sumTot').textContent = sum.total_docs ?? 0;
  resumenWrap.classList.remove('d-none');

  // Póliza fechas
  const pol = j.poliza || {};
  document.getElementById('polInicio').value = pol.fecha_inicio || '';
  document.getElementById('polFin').value = pol.fecha_fin || '';
  polizaWrap.classList.remove('d-none');

  // Documentos
  tbodyDocs.innerHTML = '';
  (j.documentos || []).forEach(d => {
    const tr = document.createElement('tr');
    function td(txt){ const el = document.createElement('td'); el.textContent = txt ?? '–'; return el; }
    tr.append(td(d.tipo_usuario), td(d.tipo_documento), td(d.nombre_archivo),
              td(d.mime), td(d.tamano_bytes), td(d.fecha_subida), td(d.ruta));
    tbodyDocs.appendChild(tr);
  });
  docsWrap.classList.remove('d-none');
});

// -------- Guardar fechas de póliza --------
document.getElementById('frmPoliza').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fi = document.getElementById('polInicio').value;
  if(!folioActual || !fi){ alert('Ingresa un folio válido y una fecha de inicio'); return; }
  const res = await fetch('/api/admin/poliza', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ folio: folioActual, fecha_inicio: fi })
  });
  const out = await res.json();
  if (out.ok){
    document.getElementById('polInicio').value = out.fecha_inicio || fi;
    document.getElementById('polFin').value = out.fecha_fin || '';
    alert('Póliza guardada');
  } else {
    alert(out.error || 'Error guardando póliza');
  }
});

// -------- Filtro de pólizas por meses restantes --------
const frmFiltro = document.getElementById('frmFiltro');
const tbodyPolizas = document.getElementById('tbodyPolizas');

frmFiltro.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const maxMeses = document.getElementById('maxMeses').value;
  const incl = document.getElementById('inclVencidas').checked ? 1 : 0;
  const r = await fetch(`/api/admin/polizas?max_meses=${maxMeses}&incluir_vencidas=${incl}`);
  const j = await r.json();
  tbodyPolizas.innerHTML = '';
  (j.items || []).forEach(p => {
    const tr = document.createElement('tr');
    const estado = p.dias_restantes < 0 ? 'Vencida' : (p.meses_restantes <= 0 ? 'Este mes' : 'Vigente');
    tr.innerHTML = `
      <td class="mono">${p.folio}</td>
      <td>${p.fecha_inicio || ''}</td>
      <td>${p.fecha_fin || ''}</td>
      <td>${p.meses_restantes}</td>
      <td>${p.dias_restantes}</td>
      <td>${estado}</td>
    `;
    tbodyPolizas.appendChild(tr);
  });
});
</script>

<!-- ======================================================= -->
<!-- ==============  Gestión de Asesores (NUEVO)  ========== -->
<!-- ======================================================= -->
<!-- WRAPPER PARA CENTRAR Y NO PEGAR A LOS BORDES -->
<div class="row">
  <div class="col-12 col-md-11 col-lg-9 col-xl-8 mx-auto px-2">

    <!-- 1) Registro de Asesores -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Registro de asesores</h2>
        <form id="form-asesor" class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Nombre del asesor</label>
            <input id="asesor_nombre" name="asesor_nombre" class="form-control" placeholder="Ej. Isabel Martínez" required>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button id="btnGuardarAsesor" type="button" class="btn btn-primary w-100">Guardar asesor</button>
          </div>
        </form>
        <div class="mt-3">
          <h3 class="h6">Asesores registrados</h3>
          <ul id="lista-asesores" class="list-group small"></ul>
        </div>
      </div>
    </div>

    <!-- 2) Crear Asesor Referenciado -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Crear asesor referenciado</h2>
        <form id="form-referenciado" class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Asesor base</label>
            <select id="asesor_base" name="asesor_base" class="form-select" required>
              <option value="">Selecciona asesor…</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Nombre del referenciado</label>
            <input id="referenciado_nombre" name="referenciado_nombre" class="form-control" placeholder="Ej. Juan Pérez" required>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="btnGuardarReferenciado" type="button" class="btn btn-primary w-100">Guardar referenciado</button>
          </div>
        </form>
        <div class="mt-2 small text-muted">
          Vista previa del nombre formateado: <span id="preview_ref" class="fw-semibold">—</span>
        </div>
        <div class="mt-3">
          <h3 class="h6">Referenciados del asesor seleccionado</h3>
          <ul id="lista-referenciados" class="list-group small"></ul>
        </div>
      </div>
    </div>

    <!-- 3) Asignar folios a asesores/referenciados -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Asignar folios</h2>
        <form id="form-asignar" class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Asesor</label>
            <select id="asesor_select" name="asesor_select" class="form-select" required>
              <option value="">Selecciona asesor…</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Folio a asignar</label>
            <input id="folio_asignar" name="folio_asignar" class="form-control mono" placeholder="AEPRA-YYYYMM-XXXX" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Asignar a</label>
            <select id="destinatario_select" name="destinatario_select" class="form-select" required>
              <option value="">Selecciona destinatario…</option>
            </select>
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button id="btnAsignarFolio" type="button" class="btn btn-success">Guardar asignación</button>
          </div>
        </form>
        <div class="mt-3">
          <h3 class="h6">Asignaciones recientes</h3>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Folio</th><th>Asesor</th><th>Asignado a</th><th>Fecha</th></tr>
              </thead>
              <tbody id="tabla-asignaciones"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 3.1) Asignar tipo de póliza a un folio (ÚNICO) -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Asignar tipo de póliza</h2>
        <div class="row g-3 align-items-end">
          <div class="col-md-5">
            <label class="form-label" for="poliza_folio">Folio</label>
            <input id="poliza_folio" class="form-control mono" placeholder="AEPRA-YYYYMM-XXXX">
          </div>
          <div class="col-md-4">
            <label class="form-label" for="poliza_tipo">Tipo de póliza</label>
            <select id="poliza_tipo" class="form-select">
              <option value="">Selecciona…</option>
              <option value="Tradicional">Tradicional</option>
              <option value="Intermedia">Intermedia</option>
              <option value="Plus">Plus</option>
              <option value="Mascota">Mascota</option>
            </select>
          </div>
          <div class="col-md-3">
            <button id="btnGuardarPoliza" class="btn btn-primary w-100">Guardar</button>
          </div>
        </div>

        <hr class="my-4">

        <h6 class="mb-2">Asignaciones de póliza recientes</h6>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr><th>Folio</th><th>Póliza</th><th>Asignado</th></tr>
            </thead>
            <tbody id="tabla-polizas-recientes">
              <tr><td colspan="3" class="text-muted">Sin datos aún</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 4) Filtro de folios por asesor/referenciado -->
    <div class="card mb-5">
      <div class="card-body">
        <h2 class="h5 mb-3">Filtrar folios por asesor o referenciado</h2>
        <form id="form-filtro" class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Asesor</label>
            <select id="filtro_asesor" name="filtro_asesor" class="form-select">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Referenciado</label>
            <select id="filtro_referenciado" name="filtro_referenciado" class="form-select" disabled>
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button id="btnFiltrarFolios" type="button" class="btn btn-outline-primary">Filtrar</button>
          </div>
        </form>
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>Folio</th><th>Asesor</th><th>Asignado a</th><th>Fecha</th></tr></thead>
            <tbody id="tabla-folios-filtrados"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- JS mínimo (UI/preview; la lógica real se conectará luego) -->
<script>
(function(){
  const $ = s => document.querySelector(s);

  async function apiGet(url){
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    return r.json();
  }
  async function apiPost(url, data){
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(data)
    });
    return r.json();
  }

  const el = {
    listaAsesores: $('#lista-asesores'),
    asesorNombre: $('#asesor_nombre'),
    btnGuardarAsesor: $('#btnGuardarAsesor'),

    asesorBase: $('#asesor_base'),
    refNombre: $('#referenciado_nombre'),
    btnGuardarRef: $('#btnGuardarReferenciado'),
    listaRef: $('#lista-referenciados'),
    previewRef: $('#preview_ref'),

    asesorSelect: $('#asesor_select'),
    destinatarioSelect: $('#destinatario_select'),
    folioAsignar: $('#folio_asignar'),
    btnAsignar: $('#btnAsignarFolio'),
    tablaAsigs: $('#tabla-asignaciones'),

    filtroAsesor: $('#filtro_asesor'),
    filtroReferenciado: $('#filtro_referenciado'),
    btnFiltrar: $('#btnFiltrarFolios'),
    tablaFiltro: $('#tabla-folios-filtrados'),
  };

  function setOptions(sel, arr, value='id', label='display'){
    sel.innerHTML = '<option value="">Selecciona…</option>' +
      arr.map(o => `<option value="${o[value]}">${o[label]}</option>`).join('');
  }

  // --------- ASESORES ---------
  async function cargarAsesores(){
    const list = await apiGet('/api/asesores');
    el.listaAsesores.innerHTML = list
      .map(a=>`<li class="list-group-item d-flex justify-content-between align-items-center">${a.nombre}<span class="badge bg-secondary">${a.id}</span></li>`)
      .join('');
    setOptions(el.asesorBase, list, 'id', 'nombre');
    setOptions(el.asesorSelect, list, 'id', 'nombre');
    setOptions(el.filtroAsesor, [{id:'',nombre:'Todos'}].concat(list), 'id', 'nombre');
  }

  el.btnGuardarAsesor?.addEventListener('click', async ()=>{
    const nombre = (el.asesorNombre.value||'').trim();
    if(!nombre) return;
    const res = await apiPost('/api/asesores', {nombre});
    if(res.ok){ el.asesorNombre.value=''; await cargarAsesores(); }
    else alert(res.error || 'Error guardando asesor');
  });

  // --------- REFERENCIADOS ---------
  async function cargarReferenciados(asesor_id){
    if(!asesor_id){ el.listaRef.innerHTML=''; return; }
    const list = await apiGet(`/api/asesores/${asesor_id}/referenciados`);
    el.listaRef.innerHTML = list
      .map(r=>`<li class="list-group-item d-flex justify-content-between align-items-center">${r.display}<span class="badge bg-light text-secondary">${r.id}</span></li>`)
      .join('');
  }

  el.asesorBase?.addEventListener('change', async ()=>{
    const id = el.asesorBase.value;
    await cargarReferenciados(id);
    await cargarDestinatarios(id, el.destinatarioSelect);
    el.filtroReferenciado.disabled = true;
  });

  el.refNombre?.addEventListener('input', ()=>{
    const opt = el.asesorBase.options[el.asesorBase.selectedIndex];
    const nombreAsesor = opt ? opt.textContent : '';
    const ini = (nombreAsesor.trim()[0]||'').toUpperCase();
    el.previewRef.textContent = (ini? ini+'. ' : '') + (el.refNombre.value||'').trim();
  });

  el.btnGuardarRef?.addEventListener('click', async ()=>{
    const asesor_id = el.asesorBase.value;
    const nombre = (el.refNombre.value||'').trim();
    if(!asesor_id || !nombre) return;
    const res = await apiPost('/api/referenciados', {asesor_id, nombre});
    if(res.ok){
      el.refNombre.value=''; el.previewRef.textContent='—';
      await cargarReferenciados(asesor_id);
      await cargarDestinatarios(asesor_id, el.destinatarioSelect);
    }else alert(res.error || 'Error guardando referenciado');
  });

  // --------- DESTINATARIOS (asesor + referenciados) ---------
  async function cargarDestinatarios(asesor_id, selectEl){
    if(!asesor_id){ selectEl.innerHTML='<option value="">Selecciona…</option>'; return; }
    const list = await apiGet(`/api/asesores/${asesor_id}/destinatarios`);
    // value como "asesor:ID" o "referenciado:ID"
    selectEl.innerHTML = '<option value="">Selecciona…</option>' +
      list.map(x => `<option value="${x.tipo}:${x.id}">${x.display}</option>`).join('');
  }
  el.asesorSelect?.addEventListener('change', ()=> cargarDestinatarios(el.asesorSelect.value, el.destinatarioSelect));

  // --------- ASIGNACIONES ---------
  async function cargarAsignacionesRecientes(){
    const list = await apiGet('/api/asignaciones/recientes');
    el.tablaAsigs.innerHTML = list
      .map(x=>`<tr><td class="mono">${x.folio}</td><td>${x.asesor_nombre}</td><td>${x.asignado_a}</td><td>${new Date(x.assigned_at).toLocaleString()}</td></tr>`)
      .join('');
  }

  el.btnAsignar?.addEventListener('click', async ()=>{
    const folio = (el.folioAsignar.value||'').trim();
    const asesor_id = el.asesorSelect.value;
    const dest = el.destinatarioSelect.value; // "asesor:12" o "referenciado:34"
    if(!folio || !asesor_id || !dest) return alert('Completa los datos para asignar.');
    let referenciado_id = null;
    if(dest.startsWith('referenciado:')) referenciado_id = dest.split(':')[1];

    const res = await apiPost('/api/asignaciones', {folio, asesor_id, referenciado_id});
    if(res.ok){ el.folioAsignar.value=''; await cargarAsignacionesRecientes(); }
    else alert(res.error || 'Error guardando la asignación');
  });

  // --------- FILTRO ---------
  el.filtroAsesor?.addEventListener('change', async ()=>{
    const asesor_id = el.filtroAsesor.value;
    if(!asesor_id){
      el.filtroReferenciado.innerHTML = '<option value="">Todos</option>';
      el.filtroReferenciado.disabled = true;
      return;
    }
    const list = await apiGet(`/api/asesores/${asesor_id}/referenciados`);
    el.filtroReferenciado.innerHTML = '<option value="">Todos</option>' +
      list.map(r=>`<option value="${r.id}">${r.display}</option>`).join('');
    el.filtroReferenciado.disabled = list.length === 0;
  });

  el.btnFiltrar?.addEventListener('click', async ()=>{
    const p = new URLSearchParams();
    if(el.filtroAsesor.value) p.set('asesor_id', el.filtroAsesor.value);
    if(el.filtroReferenciado.value) p.set('referenciado_id', el.filtroReferenciado.value);
    const list = await apiGet('/api/folios?' + p.toString());
    el.tablaFiltro.innerHTML = list
      .map(x=>`<tr><td class="mono">${x.folio}</td><td>${x.asesor_nombre}</td><td>${x.asignado_a||''}</td><td>${new Date(x.assigned_at).toLocaleString()}</td></tr>`)
      .join('');
  });

  // Arranque
  cargarAsesores();
  cargarAsignacionesRecientes();

  // ---------- Póliza: asignar tipo a folio ----------
  const polizaFolio = document.getElementById('poliza_folio');
  const polizaTipo  = document.getElementById('poliza_tipo');
  const polizaBtn   = document.getElementById('btnGuardarPoliza');
  const polizaTabla = document.getElementById('tabla-polizas-recientes');

  async function cargarPolizasRecientes(){
    try{
      const list = await apiGet('/api/folios/poliza/recientes');
      if(!Array.isArray(list) || !list.length){
        if(polizaTabla) polizaTabla.innerHTML = '<tr><td colspan="3" class="text-muted">Sin datos</td></tr>';
        return;
      }
      if(polizaTabla){
        polizaTabla.innerHTML = list.map(x => `
          <tr>
            <td class="mono">${x.folio}</td>
            <td>${x.tipo}</td>
            <td>${new Date(x.assigned_at).toLocaleString()}</td>
          </tr>
        `).join('');
      }
    }catch(e){
      if(polizaTabla){
        polizaTabla.innerHTML = '<tr><td colspan="3" class="text-muted">Disponible cuando se actualice el backend</td></tr>';
      }
    }
  }

  async function guardarTipoPoliza(){
    const folio = (polizaFolio?.value||'').trim().toUpperCase();
    const tipo  = (polizaTipo?.value||'').trim();
    if(!folio || !tipo){
      alert('Completa folio y tipo de póliza');
      return;
    }
    const res = await apiPost('/api/folios/poliza', { folio, tipo });
    if(res && res.ok){
      if(polizaFolio) polizaFolio.value='';
      if(polizaTipo)  polizaTipo.value='';
      await cargarPolizasRecientes();
    }else{
      alert((res && res.error) || 'No se pudo guardar la póliza');
    }
  }

  polizaBtn?.addEventListener('click', guardarTipoPoliza);
  cargarPolizasRecientes();
})();
</script>
</body>
</html>
